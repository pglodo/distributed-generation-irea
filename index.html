<!DOCTYPE html>
<html>

<head>
  <meta charset=utf-8 />
  <title>starter template map673 module 04</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <!-- loading Assembly CSS here -->
  <link href='https://api.mapbox.com/mapbox-assembly/v0.21.2/assembly.min.css' rel='stylesheet'>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" />
  <style>
  </style>
</head>

<body>
  <!-- loading Assembly JS here -->
  <script async defer src="https://api.mapbox.com/mapbox-assembly/v0.21.2/assembly.js"></script>

  <div class='flex-parent viewport-full relative scroll-hidden'>
    <div class='flex-child w-full w300-ml absolute static-ml left bottom'>
      <div class='flex-parent flex-parent--column viewport-third h-full hmax-full bg-white py18 px12'>
        <div class='flex-child flex-child--grow px12 py12 scroll-auto'>
          <h1 class='txt-h1 mb6'>Title here</h1>
          <p>Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Sed posuere consectetur est at lobortis. Aenean eu leo quam. Pellentesque ornare sem lacinia quam venenatis vestibulum. Aenean lacinia bibendum nulla sed consectetur.
            Lorem ipsum dolor sit amet, consectetur adipiscing elit. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus.</p>
          <h2 class='txt-xl mt18 mb12'>subheading</h2>
          <p>Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Sed posuere consectetur est at lobortis. Aenean eu leo quam. Pellentesque ornare sem lacinia quam venenatis vestibulum. Aenean lacinia bibendum nulla sed consectetur.
            Lorem ipsum dolor sit amet, consectetur adipiscing elit. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus.</p>
        </div>
        <footer class='px12 py12 bg-gray-faint txt-s'>
          <ul>
            <li>Explore the raw
              <a class='link' href='#'>data</a>
            </li>
            <li>Map authored by
              <a class='link' href='#'>Ptolemy</a>
            </li>
          </ul>
        </footer>
      </div>
    </div>
    <div class='flex-child flex-child--grow viewport-twothirds viewport-full-ml'>
      <div id="map" class='viewport-twothirds viewport-full-ml'></div>

    </div>
    <div id='info' class='py6 px12 bg-white border border--gray-light round absolute w240'>
      <p class="subName">Substation:
        <span></span>
      </p>
      <p class="subTotal">Total distributed generation:
        <span></span>
      </p>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>
  <script>
    var map = L.map('map', {
      zoomSnap: .1,
      center: [39.4, -105],
      zoom: 9,
      minZoom: 8,
      maxZoom: 13,
      maxBounds: L.latLngBounds([37.8, -107.5], [40.9, -102.0])
    });

    // add basemap
    var tiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 19
    }).addTo(map);

    // AJAX requests for the json data
    // load distributed generation data
    $.getJSON("data/distributed_generation.json", function(distGen) {
        // once complete, load substation data
        $.getJSON("data/substations.json", function(substation) {
            // use data to draw the map
            processData(distGen, substation);
          })
          .fail(function() {
            console.log("Substation data failed to load.");
          });
      })
      .fail(function() {
        console.log("Distributed generation data failed to load.");
      });

    // calculating radius of location points
    function locationRadius(val) {

      var radius = Math.sqrt(val / Math.PI);
      return radius * 1.7; // adjust the scale

    } // end of locationRadius()

    // calculating radius of substation points
    function substationRadius(val) {

      var radius = Math.sqrt(val / Math.PI);
      return radius * 0.8;

    } // end of substationRadius()

    function processData(locationData, substationData) {

      // loop through each substation record
      for (var i = 0; i < substationData.features.length; i++) {

        var props = substationData.features[i].properties;
        var locationArray = [0];

        // loop through each location record
        for (var j = 0; j < locationData.features.length; j++) {

          if (Number(props.FACILITYID) === Number(locationData.features[j].properties.SUB)) {

            locationArray.push(Number(locationData.features[j].properties.DISTGENSIZ));
          }

        } // end of location loop

        // calculate sum of array
        var sum = 0;

        for (k = 0; k < locationArray.length; k++) {
          sum += locationArray[i];
        }

        props.total = Number(sum);
        console.log(props.FACILITYID);
        console.log(locationArray);

      } // end of substation loop

      drawMap(locationData, substationData);

    } // end of processData()


    // Draw the map
    function drawMap(layer1, layer2) {

      // starter options
      var locationOptions = {
        radius: 4,
        fillColor: '#ff7800',
        color: '#000',
        weight: 1,
        opacity: 1,
        fillOpacity: 0.8
      };

      var substationOptions = {
        radius: 8,
        fillColor: '#4790F9',
        color: '#000',
        weight: 1,
        opacity: 1,
        fillOpacity: 0.8
      };

      // add distributed generation as a layer
      var distGenLayer = L.geoJSON(layer1, {
        pointToLayer: function(feature, latlng) {
          return L.circleMarker(latlng, locationOptions)
        }
      }).addTo(map);

      // add substations as a layer
      var substationLayer = L.geoJSON(layer2, {
        pointToLayer: function(feature, latlng) {
          return L.circleMarker(latlng, substationOptions)
        }
      }).addTo(map);

      resizeCircles(distGenLayer, substationLayer);

    } // end drawMap

    // RESIZING CIRCLES
    function resizeCircles(distGenLayer, substationLayer) {

      distGenLayer.eachLayer(function(layer) {
        var radius = locationRadius(Number(layer.feature.properties.DISTGENSIZ));
        layer.setRadius(radius);
      });
      substationLayer.eachLayer(function(layer) {
        if (Number(layer.feature.properties.total > 0)) {
          var radius = substationRadius(Number(layer.feature.properties.total));
          layer.setRadius(radius);
        } else {
          layer.setStyle({
            fillColor: '#DFDFDF',
            radius: 3
          });
        }

      });

      retrieveInfo(substationLayer, distGenLayer);
      // zoomSub(substationLayer, distGenLayer);

    } // end resizeCircles()

    function retrieveInfo(substationLayer, distGenLayer) {
      // select the element and reference with variable
      // and hide it from view initially
      var info = $('#info').hide();

      // since boysLayer is on top, use to detect mouseover events
      substationLayer.on('mouseover', function(e) {

        // remove the none class to display and show
        info.show();

        // access properties of target layer
        var props = e.layer.feature.properties;

        // populate HTML elements with relevant info
        $('.subName span').html(props.NAME);
        $(".subTotal span").html(props.total.toLocaleString());

        // raise opacity level as visual affordance
        e.layer.setStyle({
          fillOpacity: .6
        });

        // apply filter for only this substation's locations 
        distGenLayer.eachLayer(function(layer1) {
          if (layer1.feature.properties.SUB === props.FACILITYID) {
            layer1.setStyle({
              fillOpacity: .8
            })
          } else {
            layer1.setStyle({
              fillOpacity: 0,
              opacity: 0
            })
          }
        })

      });

      substationLayer.on('mouseout', function(e) {

        info.hide();

        e.layer.setStyle({
          fillOpacity: 0.8
        });

        // restore locations
        distGenLayer.eachLayer(function(layer1) {
          layer1.setStyle({
            fillOpacity: .8,
            opacity: 1
          })
        })

      });
    } // end retrieveInfo()


  </script>


</body>

</html>
